<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusMart Platform (v5.4)</title>
    <style>
        /* --- CORE & LAYOUT --- */
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; color: #333; transition: all 0.3s; }
        
        /* --- DARK MODE --- */
        body.dark-mode { background-color: #1a1a1a; color: #e0e0e0; }
        body.dark-mode .timer-banner { background-color: #222; border-bottom: 1px solid #444; }
        body.dark-mode .stats, body.dark-mode .chart-container { background-color: #333; }
        body.dark-mode .email-generator-container, body.dark-mode .achievement-container { background: #2b2b2b; color: #e0e0e0; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: #3e3e3e; color: #f0f0f0; border: 1px solid #555; }
        body.dark-mode .additional-fields { background-color: #3e3e3e; border-left-color: #f39c12; }
        body.dark-mode .modal-content { background-color: #2b2b2b; color: #e0e0e0; }
        body.dark-mode .tips-container { background-color: #2c3e50; border-left-color: #3498db; }
        body.dark-mode .prompt-box { background-color: #333; border-color: #555; color: #aaa; }

        /* --- THE UTILITY BELT (SCROLLABLE BANNER) --- */
        .timer-banner {
            background-color: #2c3e50; color: white; padding: 0 20px;
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            display: flex; align-items: center; 
            justify-content: flex-start; /* Start from left */
            overflow-x: auto; /* Scroll horizontal */
            white-space: nowrap; /* No wrapping */
            gap: 20px; /* Space between sections */
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            /* Hide Scrollbar */
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .timer-banner::-webkit-scrollbar { display: none; }

        /* SCROLL HINT (NEW) */
        .scroll-hint {
            position: fixed; top: 0; right: 0; height: 70px; width: 40px;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.5));
            color: white; font-size: 24px; font-weight: bold;
            display: none; align-items: center; justify-content: center;
            z-index: 1001; pointer-events: none; /* Let clicks pass through */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; transform: translateX(0); } 50% { opacity: 1; transform: translateX(-5px); } 100% { opacity: 0.5; transform: translateX(0); } }

        .left-section { 
            display: flex; align-items: center; gap: 15px; flex-shrink: 0; 
        }
        .right-section { 
            display: flex; align-items: center; gap: 15px; flex-shrink: 0; 
            margin-left: auto; 
            margin-right: 50px; padding-right: 20px;
        }
        
        .timer-container { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 6px; flex-shrink: 0; }
        .timer { font-size: 24px; font-weight: bold; margin: 0 10px; font-family: monospace; min-width: 110px; letter-spacing: 1px; }
        
        button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        .content { padding: 20px; margin-top: 90px; max-width: 1200px; margin-left: auto; margin-right: auto; }

        /* --- CHART & STATS --- */
        .stats { 
            padding: 8px 15px; background-color: #34495e; border-radius: 5px; font-size: 0.9em; font-weight: bold;
            display: flex; gap: 15px; align-items: center; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;
        }
        .chart-container {
            position: relative; width: 180px; height: 45px;
            background-color: #34495e; padding: 2px; border-radius: 5px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .chart-container:hover { background-color: #465f75; }
        .chart-container.maximized {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999; background-color: rgba(0,0,0,0.95); padding: 40px; cursor: default;
        }

        /* --- GAMIFICATION --- */
        .achievement-container {
            background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; display: flex; flex-direction: column; gap: 10px;
        }
        .badges { display: flex; justify-content: center; gap: 15px; }
        .badge {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white; opacity: 0.3; transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); background: #ccc;
        }
        .badge.earned { opacity: 1; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .badge-speed { background: linear-gradient(135deg, #4CAF50, #8BC34A); }
        .badge-consistency { background: linear-gradient(135deg, #2196F3, #03A9F4); }
        .badge-efficiency { background: linear-gradient(135deg, #9C27B0, #673AB7); }

        .progress-bar { height: 20px; background-color: #3498db; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: width 0.5s; width: 0%; }
        .tips-container { background-color: #e8f4fd; padding: 10px; border-left: 4px solid #3498db; text-align: left; display: none; border-radius: 4px; }

        /* --- EMAIL GENERATOR --- */
        .email-generator-container { 
            background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 300px; font-family: monospace; }
        
        .additional-fields {
            background-color: #fff3cd; padding: 15px; border-radius: 4px;
            margin-top: 15px; display: none; border-left: 5px solid #ffc107;
        }
        .template-header { display: flex; justify-content: space-between; align-items: flex-end; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 700px; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .helper-text { font-size: 0.85em; color: #666; margin-bottom: 10px; }
        .prompt-box { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #555; white-space: pre-wrap; cursor: pointer; }
        .prompt-box:hover { background: #e9ecef; }
        
        /* --- NOTIFICATIONS --- */
        .notification {
            position: fixed; top: 80px; right: 20px; padding: 15px 25px; border-radius: 5px; color: white; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 3000; transform: translateX(120%); transition: transform 0.4s;
        }
        .notification.show { transform: translateX(0); }
        .notification-success { background-color: #27ae60; }
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 9999; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        /* --- TOGGLE BUTTON --- */
        .toggle-btn { 
            background: #555; color: white; width: 60px; height: 40px; line-height: 40px;
            text-align: center; padding: 0; border-radius: 20px; font-size: 20px; 
            flex-shrink: 0; border: 2px solid #777; cursor: pointer;
        }
        .toggle-btn:hover { background: #666; }
        .toggle-btn.active { background: #f39c12; border-color: #e67e22; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="timer-banner" id="timerBanner">
    <div id="scrollHint" class="scroll-hint">¬ª</div>

    <div class="left-section">
        <div class="timer-container">
            <span>üìß</span> <div id="display1" class="timer">00:00:00</div>
            <button onclick="toggleTimer(1)" id="btn1" style="background:#2ecc71; color:white;">Start</button>
            <button onclick="editTimer(1)" style="background:#f39c12; color:white;">‚úé</button>
        </div>
        <div class="timer-container">
            <span>‚òéÔ∏è</span> <div id="display2" class="timer">00:00:00</div>
            <button onclick="toggleTimer(2)" id="btn2" style="background:#2ecc71; color:white;">Start</button>
            <button onclick="editTimer(2)" style="background:#f39c12; color:white;">‚úé</button>
        </div>
    </div>
    
    <div class="right-section">
        <div class="stats">
            <span>Contacts: <span id="count">0</span></span>
            <span style="opacity:0.3">|</span>
            <span>Avg: <span id="avg">00:00:00</span></span>
        </div>

        <div class="chart-container" id="chartBox" onclick="this.classList.toggle('maximized')" title="Click to Maximize">
            <canvas id="ahtChart"></canvas>
        </div>
        
        <button onclick="openModal('vaultModal')" style="background:#8e44ad; color:white;">üíæ Vault</button>
        <button id="darkModeBtn" onclick="toggleDarkMode()" class="toggle-btn" title="Toggle Night Mode">üåô</button>
    </div>
</div>

<div class="content">
    
    <div class="achievement-container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:left;">
                <h3 style="margin:0;">Performance</h3>
                <span id="level-title" style="color:#f39c12; font-weight:bold;">Beginner Agent</span>
            </div>
            <div class="badges">
                <div class="badge badge-speed" id="badge-speed" title="Speed">‚ö°</div>
                <div class="badge badge-consistency" id="badge-consistency" title="Consistency">üîÑ</div>
                <div class="badge badge-efficiency" id="badge-efficiency" title="Efficiency">‚è±Ô∏è</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:20px; font-weight:bold;" id="streak">0</div>
                <span style="font-size:12px; color:#888;">Streak</span>
            </div>
        </div>
        <div style="background:#ddd; height:20px; border-radius:10px; width:100%;">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>
        <div id="tips-container" class="tips-container">
            <strong>Tip:</strong> <span id="tip-text">Use macros to save time.</span>
        </div>
    </div>

    <div class="email-generator-container">
        <div class="template-header">
            <h1>NexusMart Response Builder</h1>
            <button onclick="openModal('templateModal')" style="background:#3498db; color:white;">‚ûï Manage Templates</button>
        </div>

        <div class="grid-layout">
            <div>
                <label>Select Template (Auto-Sorted by Usage):</label>
                <select id="templateSelect" onchange="loadTemplate()">
                    <option value="">-- Select Template --</option>
                    </select>

                <label>Customer Name:</label>
                <input id="f_customerName" placeholder="John Doe" oninput="renderEmail()">
                
                <label>Order ID:</label>
                <input id="f_orderID" placeholder="123-456" oninput="renderEmail()">
                
                <label>Item Name:</label>
                <input id="f_itemName" placeholder="Widget X" oninput="renderEmail()">
                
                <label>Amount:</label>
                <input id="f_amount" placeholder="$50.00" oninput="renderEmail()">

                <div id="dynamicFields" class="additional-fields"></div>
            </div>

            <div>
                <label>Live Preview:</label>
                <textarea id="outputEmail" placeholder="Select a template..."></textarea>
                <div style="margin-top:10px; text-align:right;">
                    <button onclick="copyEmail()" style="background:#FF9900; color:white; padding:10px 20px;">üìã Copy</button>
                    <button onclick="clearFields()" style="background:#95a5a6; color:white; padding:10px 20px;">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="vaultModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('vaultModal')">&times;</span>
        <h2>üíæ The Data Vault</h2>
        <p class="helper-text">Copy this text to save your stats AND templates.</p>
        <textarea id="jsonExport" style="height:150px;"></textarea>
        
        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button onclick="resetToday()" style="background:#f39c12; color:white;">üîÑ Reset Today's Stats</button>
            
            <div style="display:flex; gap:10px;">
                <button onclick="copyJson()" style="background:#2980b9; color:white;">Copy Code</button>
                <button onclick="loadJson()" style="background:#27ae60; color:white;">Load Code</button>
                <button onclick="resetAll()" style="background:#c0392b; color:white;">Factory Reset</button>
            </div>
        </div>
    </div>
</div>

<div id="templateModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('templateModal')">&times;</span>
        <h2>üõ†Ô∏è Template Manager</h2>
        
        <div style="margin-bottom: 20px;">
            <p class="helper-text"><strong>Need a template? Ask AI.</strong> Click below to copy prompt:</p>
            <div class="prompt-box" onclick="copyPrompt(this)" title="Click to Copy">Create an email to customer and apologize and empathize for their late order. use {curly_braces} as input fields will as automatically be created. Standard keys: {customerName}, {orderID}, {itemName}, {amount}.</div>
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

        <label>Template Name:</label>
        <input id="newTmplName" placeholder="e.g. Damaged Item Response">
        
        <label>Template Body:</label>
        <textarea id="newTmplBody" style="height:150px;" placeholder="Hello {customerName}, regarding your issue with {itemName}..."></textarea>
        
        <div style="text-align:right; margin-top:10px;">
            <button onclick="saveTemplate()" style="background:#27ae60; color:white;">üíæ Save / Update</button>
        </div>
        
        <h3>Existing Templates (Sorted by Usage):</h3>
        <ul id="customTmplList" style="text-align:left; max-height:200px; overflow-y:auto; border:1px solid #eee; padding:10px; list-style:none; margin:0;"></ul>
    </div>
</div>

<script>
    // --- SEED DATA ---
    const SEED_TEMPLATES = {
        't_standard': { name: "Standard Closing", usage: 0, body: "Hello {customerName},\n\nGlad I could help regarding {itemName}.\n\nHelp Center: https://github.com/sancoisaacs\n\nNexusMart Team" },
        't_refund': { name: "Refund Processed", usage: 0, body: "Hello {customerName},\n\nRefund of {amount} processed for order {orderID}.\n\nFunds in 3-5 days.\n\nNexusMart Team" },
        't_pending': { name: "Shipping Delay", usage: 0, body: "Hello {customerName},\n\nOrder {orderID} is delayed. Expediting now.\n\nSorry for the wait." },
        't_apology': { name: "Apology + Voucher", usage: 0, body: "Hello {customerName},\n\nSorry about order {orderID}. Voucher {voucherCode} added (Exp: {expiryDate})." },
        't_priceMatch': { name: "Price Match Policy", usage: 0, body: "Hello {customerName},\n\nWe cannot price match retrospectively.\n\nReturns available: https://github.com/sancoisaacs" },
        't_pickupNo': { name: "Courier Pickup", usage: 0, body: "Hello {customerName},\n\nPickup arranged for {itemName}. Courier bringing label.\n\nRef: {orderID}" },
        't_stuckUpdate': { name: "Stock Update", usage: 0, body: "Hello {customerName},\n\n{itemName} stock arriving soon. Est delivery: {deliveryDate}." }
    };

    // --- STATE ---
    let app = {
        stats: { email:[], phone:[], total:0, count:0, streak:0 },
        badges: { speed:false, consist:false, effic:false },
        templates: {},
        theme: 'light'
    };
    let timers = { 1:null, 2:null };
    let tVals = { 1:[0,0,0], 2:[0,0,0] };
    let chart;

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData(); initChart(); 
        
        if(Object.keys(app.templates).length === 0) {
            app.templates = JSON.parse(JSON.stringify(SEED_TEMPLATES));
        }
        
        renderDropdown(); renderManagerList();
        applyTheme();
        
        // Initial check for scroll
        checkScroll();
        window.addEventListener('resize', checkScroll);
        document.getElementById('timerBanner').addEventListener('scroll', checkScroll);
    });

    // --- SCROLL HINT LOGIC ---
    function checkScroll() {
        let b = document.getElementById('timerBanner');
        let hint = document.getElementById('scrollHint');
        // Show hint if scrollable AND not scrolled to end
        if(b.scrollWidth > b.clientWidth && (b.scrollLeft + b.clientWidth < b.scrollWidth - 10)) {
            hint.style.display = 'flex';
        } else {
            hint.style.display = 'none';
        }
    }

    // --- TIMERS ---
    function fmt(t) { return `${String(t[0]).padStart(2,'0')}:${String(t[1]).padStart(2,'0')}:${String(t[2]).padStart(2,'0')}`; }
    function toggleTimer(id) {
        let btn = document.getElementById(`btn${id}`);
        if(!timers[id]) {
            timers[id] = setInterval(()=>{
                tVals[id][2]++; if(tVals[id][2]==60){tVals[id][2]=0;tVals[id][1]++;} if(tVals[id][1]==60){tVals[id][1]=0;tVals[id][0]++;}
                document.getElementById(`display${id}`).textContent = fmt(tVals[id]);
            },1000);
            btn.textContent = "Stop"; btn.style.backgroundColor = "#e74c3c";
        } else {
            clearInterval(timers[id]); timers[id]=null;
            let secs = tVals[id][0]*3600 + tVals[id][1]*60 + tVals[id][2];
            saveContact(secs, id===1?'email':'phone');
            tVals[id]=[0,0,0]; document.getElementById(`display${id}`).textContent = "00:00:00";
            btn.textContent = "Start"; btn.style.backgroundColor = "#2ecc71";
        }
    }
    function editTimer(id) {
        let input = prompt("Enter Minutes (e.g. 6) or Time (e.g. 6:30)");
        if(!input) return;
        let p = input.includes(':') ? input.split(':').map(Number) : [parseInt(input), 0];
        if(p.length===1) p=[p[0],0];
        tVals[id] = [0, p[0], p[1]||0];
        document.getElementById(`display${id}`).textContent = fmt(tVals[id]);
    }

    // --- LOGIC & GAMIFICATION ---
    function saveContact(sec, type) {
        app.stats.total += sec; app.stats.count++;
        app.stats[type].push(sec);
        
        let min = sec/60;
        if(min < 9) app.stats.streak++; else app.stats.streak=0;
        if(min < 7 && !app.badges.speed) { app.badges.speed=true; notify("‚ö° Speed Badge!"); }
        if(app.stats.streak>=5 && !app.badges.consist) { app.badges.consist=true; notify("üîÑ Consistency Badge!"); }
        let avg = (app.stats.total/app.stats.count)/60;
        if(app.stats.count>=10 && avg<9 && !app.badges.effic) { app.badges.effic=true; notify("‚è±Ô∏è Efficiency Badge!"); }
        
        saveData(); updateUI();
    }

    function updateUI() {
        document.getElementById('count').textContent = app.stats.count;
        document.getElementById('streak').textContent = app.stats.streak;
        
        let avgSec = app.stats.count ? Math.floor(app.stats.total/app.stats.count) : 0;
        let h=Math.floor(avgSec/3600), m=Math.floor((avgSec%3600)/60), s=avgSec%60;
        document.getElementById('avg').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        document.getElementById('badge-speed').classList.toggle('earned', app.badges.speed);
        document.getElementById('badge-consistency').classList.toggle('earned', app.badges.consist);
        document.getElementById('badge-efficiency').classList.toggle('earned', app.badges.effic);

        let all = [...app.stats.email, ...app.stats.phone];
        let bar = document.getElementById('progress-bar');
        let tips = document.getElementById('tips-container');
        if(!all.length) { bar.style.width="0%"; bar.textContent="0%"; tips.style.display="none"; }
        else {
            let avgM = (all.reduce((a,b)=>a+b,0)/all.length)/60;
            if(avgM < 9) {
                let pct = 100 + Math.min(50, ((9-avgM)/4.5)*50);
                bar.style.width = Math.min(pct,100)+"%"; bar.style.background="#2ecc71"; bar.textContent="Target Met!";
                tips.style.display="none";
            } else {
                let pct = Math.max(10, ((13-avgM)/4)*100);
                bar.style.width = pct+"%"; bar.style.background="#e74c3c"; bar.textContent="Over Target";
                tips.style.display="block";
            }
        }
        if(chart) {
            let eAvg = app.stats.email.length ? (app.stats.email.reduce((a,b)=>a+b,0)/app.stats.email.length)/60 : 0;
            let pAvg = app.stats.phone.length ? (app.stats.phone.reduce((a,b)=>a+b,0)/app.stats.phone.length)/60 : 0;
            chart.data.datasets[0].data = [eAvg, pAvg];
            chart.update();
        }
    }

    // --- TEMPLATES ---
    let currentTemplate = "";

    function renderDropdown() {
        let sel = document.getElementById('templateSelect');
        let selectedVal = sel.value; 
        sel.innerHTML = '<option value="">-- Select Template --</option>';

        let sorted = Object.entries(app.templates).sort((a,b) => b[1].usage - a[1].usage);

        sorted.forEach(([id, t]) => {
            let opt = document.createElement('option');
            opt.value = id; 
            opt.textContent = `${t.name} ${t.usage>0 ? '('+t.usage+')' : ''}`;
            sel.appendChild(opt);
        });
        if(app.templates[selectedVal]) sel.value = selectedVal;
    }

    function loadTemplate() {
        let val = document.getElementById('templateSelect').value;
        if(!val) return;

        if(app.templates[val]) {
            app.templates[val].usage = (app.templates[val].usage || 0) + 1;
            saveData();
        }

        currentTemplate = app.templates[val].body;
        
        let regex = /\{(\w+)\}/g;
        let matches = [...currentTemplate.matchAll(regex)].map(m => m[1]);
        let unique = [...new Set(matches)];

        let container = document.getElementById('dynamicFields');
        container.innerHTML = '';
        let hasDynamic = false;

        unique.forEach(key => {
            if(['customerName','orderID','itemName','amount'].includes(key)) return;
            hasDynamic = true;
            let label = key.replace(/([A-Z])/g, ' $1').trim();
            let html = `<label>${label}:</label><input class="dyn-input" data-key="${key}" placeholder="Enter ${label}" oninput="renderEmail()">`;
            container.innerHTML += html;
        });

        container.style.display = hasDynamic ? 'block' : 'none';
        renderEmail();
    }

    function renderEmail() {
        let txt = currentTemplate;
        txt = txt.replace(/{customerName}/g, document.getElementById('f_customerName').value || "[Name]");
        txt = txt.replace(/{orderID}/g, document.getElementById('f_orderID').value || "[Order#]");
        txt = txt.replace(/{itemName}/g, document.getElementById('f_itemName').value || "[Item]");
        txt = txt.replace(/{amount}/g, document.getElementById('f_amount').value || "[Amt]");

        document.querySelectorAll('.dyn-input').forEach(inp => {
            let key = inp.dataset.key;
            let val = inp.value || `[${key}]`;
            txt = txt.replaceAll(`{${key}}`, val);
        });
        document.getElementById('outputEmail').value = txt;
    }

    function renderManagerList() {
        let list = document.getElementById('customTmplList');
        list.innerHTML = "";
        
        let sorted = Object.entries(app.templates).sort((a,b) => b[1].usage - a[1].usage);

        sorted.forEach(([id, t]) => {
            let li = document.createElement('li');
            li.style.cssText = "padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;";
            li.innerHTML = `<span><strong>${t.name}</strong> <small style="color:#888">Used: ${t.usage}</small></span> <button onclick="deleteTemplate('${id}')" style="font-size:10px; background:#e74c3c; color:white;">Delete</button>`;
            list.appendChild(li);
        });
    }

    function saveTemplate() {
        let name = document.getElementById('newTmplName').value;
        let body = document.getElementById('newTmplBody').value;
        if(!name || !body) return alert("Fill in both fields");
        
        let id = "cust_" + Date.now();
        app.templates[id] = { name, body, usage: 0 };
        
        saveData(); 
        renderDropdown(); renderManagerList(); 
        document.getElementById('newTmplName').value = '';
        document.getElementById('newTmplBody').value = '';
        notify("Template Saved!");
    }

    function deleteTemplate(id) {
        if(confirm("Delete this template?")) {
            delete app.templates[id];
            saveData(); renderDropdown(); renderManagerList();
        }
    }

    function copyPrompt(el) {
        let text = el.innerText;
        navigator.clipboard.writeText(text);
        notify("AI Prompt Copied!");
    }

    // --- DATA VAULT ---
    function saveData() { localStorage.setItem('nexusMart_v5', JSON.stringify(app)); }
    function loadData() {
        let raw = localStorage.getItem('nexusMart_v5');
        if(raw) {
            let loaded = JSON.parse(raw);
            app = { ...app, ...loaded };
            updateUI();
        }
    }
    function resetToday() {
        if(confirm("Reset Stats for today?")) { app.stats={email:[], phone:[], total:0, count:0, streak:0}; saveData(); updateUI(); notify("Stats Reset!"); }
    }
    function resetAll() {
        if(confirm("FACTORY RESET? This wipes everything.")) { 
            localStorage.removeItem('nexusMart_v5'); location.reload(); 
        }
    }
    
    // JSON Modal
    function openModal(id) { 
        if(id==='vaultModal') document.getElementById('jsonExport').value = JSON.stringify(app, null, 2);
        if(id==='templateModal') renderManagerList();
        document.getElementById(id).style.display='block'; 
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function copyJson() { document.getElementById('jsonExport').select(); document.execCommand('copy'); notify("Copied!"); }
    function loadJson() {
        try { app = JSON.parse(document.getElementById('jsonExport').value); saveData(); location.reload(); }
        catch(e) { alert("Invalid JSON"); }
    }

    // --- UTILS ---
    function notify(msg) {
        let n = document.createElement('div'); n.className = 'notification notification-success'; n.textContent = msg;
        document.body.appendChild(n); void n.offsetWidth; n.classList.add('show');
        setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(),500); }, 3000);
    }
    function clearFields() {
        document.querySelectorAll('input').forEach(i=>i.value='');
        document.querySelector('textarea').value='';
    }
    function copyEmail() { document.getElementById('outputEmail').select(); document.execCommand('copy'); notify("Copied!"); }

    // --- THEME ---
    function toggleDarkMode() {
        app.theme = (app.theme === 'light') ? 'dark' : 'light';
        applyTheme();
        saveData();
    }
    function applyTheme() {
        let isDark = (app.theme === 'dark');
        document.body.classList.toggle('dark-mode', isDark);
        let btn = document.getElementById('darkModeBtn');
        btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        btn.className = `toggle-btn ${isDark ? 'active' : ''}`;
    }

    function initChart() {
        let ctx = document.getElementById('ahtChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Email', 'Phone'], datasets: [{ data: [0, 0], backgroundColor: ['#3498db', '#2ecc71'] }] },
            options: { plugins: {legend:{display:false}}, scales:{y:{beginAtZero:true, ticks:{color:'white'}}, x:{ticks:{color:'white'}}}, maintainAspectRatio:false }
        });
    }
</script>
</body>
</html>
